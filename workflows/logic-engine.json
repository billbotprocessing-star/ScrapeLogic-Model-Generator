/**
 * ScrapeLogic Data Formatter (Apify Edition)
 * Optimized for n8n to prevent "Red Node" crashes.
 */

// 1. Safety Check: If there's no input at all, return an error object instead of crashing
if (!$input.all() || $input.all().length === 0) {
    return { 
        cleaned_website_data: "Error: No data received from crawler.",
        metadata: { title: "Crawl Failed" } 
    };
}

// 2. Extract results using the modern n8n accessor
const apifyResults = $input.first().json;
const result = Array.isArray(apifyResults) ? apifyResults[0] : apifyResults;

// 3. Robust Data Check: Ensure result exists before accessing properties
if (!result) {
    return { 
        cleaned_website_data: "Error: Crawler returned an empty dataset.",
        metadata: { title: "No Data Found" } 
    };
}

// 4. Content Prioritization
let rawData = result.markdown || result.text || result.content || "";

const cleanContent = (text) => {
    if (!text || text.trim().length === 0) return "No content extracted from page.";

    return text
        // Strip common "Noise" strings
        .replace(/Terms of Service|Privacy Policy|Cookie Policy|All Rights Reserved/gi, "")
        // Clean up Markdown links and images to save tokens
        .replace(/!\[.*?\]\(.*?\)/g, "")
        .replace(/\[.*?\]\(.*?\)/g, (match) => match.split(']')[0].replace('[', ''))
        // Final Formatting
        .replace(/\s+/g, " ")
        .trim()
        .substring(0, 12000); 
};

// 5. Final Output
return {
    cleaned_website_data: cleanContent(rawData),
    metadata: {
        title: result.metadata?.title || "Unknown Site",
        description: result.metadata?.description || "No meta description",
        url: result.url || "URL missing"
    }
};

